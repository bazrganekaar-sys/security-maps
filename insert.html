<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Ø³ÛŒØ³ØªÛ•Ù…ÛŒ Ø¦Û•Ù…Ù†ÛŒ Ú©ÙˆØ±Ø¯Ø³ØªØ§Ù† - ÙˆÛ•Ø´Ø§Ù†Û• Ø¦Û†Ù†ÚµØ§ÛŒÙ†Û• Ù¾Ú•Û†Ú©Û•</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <style>
        :root { --k-red: #ee352e; --k-yellow: #fecb00; --k-green: #27ae60; --k-dark: #1a252f; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; height: 100vh; background: #f0f2f5; overflow: hidden; }
        
        /* Login UI */
        #login-page { position: fixed; inset: 0; background: linear-gradient(135deg, var(--k-red) 0%, var(--k-yellow) 50%, var(--k-green) 100%); z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .login-card { background: white; padding: 40px; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .login-card input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 2px solid #eee; box-sizing: border-box; }
        
        #main-app { display: none; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* Sidebar */
        #sidebar { position: fixed; top: 0; right: -420px; width: 400px; height: 100%; background: var(--k-dark); color: white; padding: 20px; transition: 0.4s; z-index: 2000; overflow-y: auto; box-sizing: border-box; }
        #sidebar.active { right: 0; }
        
        /* Buttons */
        .toggle-btn { position: fixed; top: 20px; right: 20px; z-index: 2001; background: var(--k-green); color: white; width: 55px; height: 55px; border: none; border-radius: 50%; cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .locate-btn { background: white; border: 2px solid rgba(0,0,0,0.2); border-radius: 4px; width: 34px; height: 34px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; margin-bottom: 5px; }
        
        /* Form Styling */
        .input-group { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 15px; border-right: 4px solid var(--k-yellow); }
        .dynamic-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .dynamic-row input { flex: 1; padding: 8px; border-radius: 6px; border: none; font-size: 13px; color: #333; }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: bold; font-size: 14px; color: var(--k-yellow); }
        .add-row-btn { background: var(--k-green); color: white; border: none; border-radius: 6px; padding: 4px 10px; cursor: pointer; }
        .save-btn { background: var(--k-green); color: white; padding: 14px; width: 100%; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
        
        /* Modal */
        #details-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95%; max-width: 700px; background: white; padding: 25px; z-index: 3000; border-radius: 20px; max-height: 90vh; overflow-y: auto; color: #1a252f; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2999; backdrop-filter: blur(5px); }
        .info-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .info-table th, .info-table td { padding: 10px; border: 1px solid #dee2e6; text-align: center; font-size: 13px; }
        .section-title { background: var(--k-dark); color: white; padding: 8px; font-weight: bold; border-radius: 8px; margin-top: 20px; text-align: center; }
        
        /* Admin Section */
        .admin-only { display: none; }
        .delete-btn { background: var(--k-red); color: white; border: none; cursor: pointer; border-radius: 4px; padding: 4px 8px; }
    </style>
</head>
<body>

    <div id="login-page">
        <div class="login-card">
            <h1>â˜€ï¸</h1>
            <h2>Ø³ÛŒØ³ØªÛ•Ù…ÛŒ Ø¦Û•Ù…Ù†ÛŒ Ú©ÙˆØ±Ø¯Ø³ØªØ§Ù†</h2>
            <input type="text" id="login-user" placeholder="Ù†Ø§ÙˆÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±">
            <input type="password" id="login-pass" placeholder="Ù¾Ø§Ø³Û†Ø±Ø¯">
            <button onclick="checkLogin()" style="width:100%; padding:15px; background: var(--k-dark); color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">Ø¯Ø§Ø®ÚµØ¨ÙˆÙˆÙ†</button>
        </div>
    </div>

    <div id="main-app">
        <button class="toggle-btn" onclick="toggleSidebar()">â˜°</button>
        <div id="sidebar">
            <h3 id="user-welcome" style="text-align:center; color: var(--k-yellow);"></h3>
            
            <div class="admin-only">
                <div class="input-group">
                    <input type="text" id="p_name" placeholder="Ù†Ø§ÙˆÛŒ Ù¾Ú•Û†Ú˜Û•" style="width:100%; padding:10px; border-radius:8px; border:none; margin-bottom:10px;">
                    <div style="display:flex; gap:10px;">
                        <select id="p_type" style="flex:1; padding:10px; border-radius:8px;"><option value="Ú©Û†Ù…Ù¾Ø§Ù†ÛŒØ§">Ú©Û†Ù…Ù¾Ø§Ù†ÛŒØ§</option><option value="Ø­Ú©ÙˆÙ…ÛŒ">Ø­Ú©ÙˆÙ…ÛŒ</option></select>
                        <input type="text" id="p_shift" placeholder="Ø´Û•ÙØª" style="flex:1; padding:10px; border-radius:8px;">
                    </div>
                </div>

                <div class="input-group" id="group-tl"><div class="header-row"><span>ğŸ‘¤ ØªÛŒÙ… Ù„ÛØ¯Û•Ø±</span> <button class="add-row-btn" onclick="addRow('group-tl', 2)">+</button></div><div class="dynamic-row"><input type="text" placeholder="Ù†Ø§Ùˆ"> <input type="text" placeholder="Ù…Û†Ø¨Ø§ÛŒÙ„"></div></div>
                <div class="input-group" id="group-guard"><div class="header-row"><span>ğŸ›¡ï¸ Ù¾Ø§Ø³Û•ÙˆØ§Ù†</span> <button class="add-row-btn" onclick="addRow('group-guard', 2)">+</button></div><div class="dynamic-row"><input type="text" placeholder="Ù†Ø§Ùˆ"> <input type="text" placeholder="Ù…Û†Ø¨Ø§ÛŒÙ„"></div></div>
                <div class="input-group" id="group-car"><div class="header-row"><span>ğŸš— Ø¦Û†ØªÛ†Ù…Ø¨ÛÙ„</span> <button class="add-row-btn" onclick="addRow('group-car', 3)">+</button></div><div class="dynamic-row"><input type="text" placeholder="Ø¬Û†Ø±"> <input type="text" placeholder="Ú•Û•Ù†Ú¯"> <input type="text" placeholder="Ù…Û†Ø¯ÛÙ„"></div></div>
                <div class="input-group" id="group-wp"><div class="header-row"><span>ğŸ”« Ú†Û•Ú© Ùˆ ÙÛŒØ´Û•Ú©</span> <button class="add-row-btn" onclick="addRow('group-wp', 3)">+</button></div><div class="dynamic-row"><input type="text" placeholder="Ø¬Û†Ø±"> <input type="text" placeholder="Ú©Û†Ø¯"> <input type="number" placeholder="ÙÛŒØ´Û•Ú©"></div></div>

                <input type="hidden" id="lat"><input type="hidden" id="lng">
                <button onclick="saveToCloud()" class="save-btn">ğŸ’¾ Ù¾Ø§Ø´Û•Ú©Û•ÙˆØªÚ©Ø±Ø¯Ù† Ù„Û• Ø³ÛØ±Ú¤Û•Ø±</button>
            </div>

            <h4 style="color:var(--k-green); margin-top:20px;">ğŸ“‹ Ù„ÛŒØ³ØªÛŒ Ù¾Ú•Û†Ú˜Û•Ú©Ø§Ù†:</h4>
            <div id="items-container"></div>
            <button onclick="location.reload()" style="background:var(--k-red); color:white; width:100%; padding:15px; border:none; border-radius:12px; margin-top:25px; cursor:pointer; font-weight:bold;">ğŸšª Ø¯Û•Ø±Ú†ÙˆÙˆÙ†</button>
        </div>
        <div id="map"></div>
    </div>

    <div class="overlay" id="overlay" onclick="closeModal()"></div>
    <div id="details-modal">
        <div style="display:flex; justify-content:space-between; border-bottom: 2px solid #eee; padding-bottom:10px;">
            <h2 id="m_title" style="margin:0; color:var(--k-red);"></h2>
            <button onclick="closeModal()" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <div id="m_content"></div>
    </div>

    <script>
        // *** Firebase Configuration ***
        const firebaseConfig = {
            apiKey: "AIzaSyDLrsmG0rFXohabE6VSI-JTrC0EGpo3f6k",
            authDomain: "manager-map-7e19c.firebaseapp.com",
            databaseURL: "https://manager-map-7e19c-default-rtdb.firebaseio.com",
            projectId: "manager-map-7e19c",
            storageBucket: "manager-map-7e19c.firebasestorage.app",
            messagingSenderId: "1038922185503",
            appId: "1:1038922185503:web:de08e0c5ad0b7e15778e2a"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentUser = null;
        let map, editMarker, myLocMarker, allMarkers = [];

        function checkLogin() {
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();
            db.ref('users').once('value', snap => {
                const users = snap.val();
                let found = null;
                for(let id in users) { if(users[id].name === u && users[id].pass === p) found = users[id]; }
                if(!found && u === "admin" && p === "3515217320251097") found = {name: "Ø¦Û•Ø¯Ù…ÛŒÙ†", role: "admin"};
                if(found) { currentUser = found; startApp(); } else { alert("Ù‡Û•ÚµÛ•ÛŒÛ•!"); }
            });
        }

        function startApp() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('user-welcome').innerText = "Ø¨Û•Ø®ÛØ±Ø¨ÛÛŒØª " + currentUser.name;
            
            map = L.map('map', {zoomControl: false}).setView([36.19, 44.01], 8);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            // 1. ADD SEARCH TO MAP
            L.Control.geocoder({ position: 'topleft', placeholder: 'Ú¯Û•Ú•Ø§Ù† Ø¨Û† Ø´ÙˆÛÙ†...' }).addTo(map);

            // 2. ADD MY LOCATION BUTTON
            const LocateBtn = L.Control.extend({
                options: { position: 'topleft' },
                onAdd: function() {
                    const btn = L.DomUtil.create('div', 'locate-btn leaflet-bar leaflet-control');
                    btn.innerHTML = 'ğŸ“';
                    btn.title = "Ø´ÙˆÛÙ†ÛŒ Ù…Ù† Ù†ÛŒØ´Ø§Ù† Ø¨Ø¯Û•";
                    btn.onclick = () => map.locate({setView: true, maxZoom: 16});
                    return btn;
                }
            });
            map.addControl(new LocateBtn());

            map.on('locationfound', e => {
                if(myLocMarker) map.removeLayer(myLocMarker);
                myLocMarker = L.marker(e.latlng, {icon: L.divIcon({className: 'my-loc', html: 'ğŸ”µ', iconSize: [20, 20]})}).addTo(map);
                L.popup().setLatLng(e.latlng).setContent("ØªÛ† Ù„ÛØ±Û•ÛŒØª").openOn(map);
            });

            if(currentUser.role === 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                map.on('click', e => {
                    if(editMarker) map.removeLayer(editMarker);
                    editMarker = L.marker(e.latlng).addTo(map);
                    document.getElementById('lat').value = e.latlng.lat;
                    document.getElementById('lng').value = e.latlng.lng;
                });
            }

            db.ref('projects').on('value', snap => { renderMarkers(snap.val()); updateSidebarList(snap.val()); });
        }

        function addRow(id, cols) {
            const g = document.getElementById(id);
            const d = document.createElement('div'); d.className = 'dynamic-row';
            let html = ''; for(let i=0; i<cols; i++) html += `<input type="text">`;
            d.innerHTML = html; g.appendChild(d);
        }

        function collect(id) {
            const rows = document.getElementById(id).querySelectorAll('.dynamic-row');
            let data = [];
            rows.forEach(r => {
                const ins = r.querySelectorAll('input');
                if(ins[0].value) data.push({c1: ins[0].value, c2: ins[1].value, c3: ins[2] ? ins[2].value : ''});
            });
            return data;
        }

        function saveToCloud() {
            const name = document.getElementById('p_name').value;
            const lat = document.getElementById('lat').value;
            if(!name || !lat) return alert("Ù†Ø§Ùˆ Ùˆ Ø´ÙˆÛÙ† Ø¯ÛŒØ§Ø±ÛŒ Ø¨Ú©Û•!");
            db.ref('projects').push({
                name: name, type: document.getElementById('p_type').value, shift: document.getElementById('p_shift').value,
                tls: collect('group-tl'), guards: collect('group-guard'), cars: collect('group-car'), weapons: collect('group-wp'),
                lat: lat, lng: document.getElementById('lng').value
            });
            alert("Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ú©Ø±Ø§!");
            if(editMarker) map.removeLayer(editMarker);
        }

        function renderMarkers(data) {
            allMarkers.forEach(m => map.removeLayer(m));
            for(let id in data) {
                const p = data[id];
                const m = L.marker([p.lat, p.lng]).addTo(map).bindPopup(`<b>${p.name}</b><br><button onclick="showDetails('${id}')">Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ</button>`);
                allMarkers.push(m);
            }
        }

        window.showDetails = function(id) {
            db.ref('projects/' + id).once('value', snap => {
                const p = snap.val();
                document.getElementById('m_title').innerText = p.name;
                let h = `<div class="section-title">Ú¯Ø´ØªÛŒ</div><table class="info-table"><tr><td>Ø¬Û†Ø±: ${p.type}</td><td>Ø´Û•ÙØª: ${p.shift}</td></tr></table>`;
                const tbl = (title, d, h1, h2, h3) => {
                    if(!d || d.length === 0) return '';
                    let t = `<div class="section-title">${title}</div><table class="info-table"><tr><th>${h1}</th><th>${h2}</th>${h3?`<th>${h3}</th>`:''}</tr>`;
                    d.forEach(x => t += `<tr><td>${x.c1}</td><td>${x.c2}</td>${h3?`<td>${x.c3}</td>`:''}</tr>`);
                    return t + '</table>';
                };
                h += tbl("ğŸ‘¤ ØªÛŒÙ… Ù„ÛØ¯Û•Ø±", p.tls, "Ù†Ø§Ùˆ", "Ù…Û†Ø¨Ø§ÛŒÙ„") + tbl("ğŸ›¡ï¸ Ù¾Ø§Ø³Û•ÙˆØ§Ù†", p.guards, "Ù†Ø§Ùˆ", "Ù…Û†Ø¨Ø§ÛŒÙ„") + tbl("ğŸš— Ø¦Û†ØªÛ†Ù…Ø¨ÛÙ„", p.cars, "Ø¬Û†Ø±", "Ú•Û•Ù†Ú¯", "Ù…Û†Ø¯ÛÙ„") + tbl("ğŸ”« Ú†Û•Ú©", p.weapons, "Ø¬Û†Ø±", "Ú©Û†Ø¯", "ÙÛŒØ´Û•Ú©");
                document.getElementById('m_content').innerHTML = h;
                document.getElementById('details-modal').style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
            });
        }

        function updateSidebarList(data) {
            const cont = document.getElementById('items-container'); cont.innerHTML = "";
            for(let id in data) {
                cont.innerHTML += `<div class="input-group" style="display:flex; justify-content:space-between; align-items:center;">
                    <span onclick="map.setView([${data[id].lat}, ${data[id].lng}], 15)" style="cursor:pointer;">ğŸ“ ${data[id].name}</span>
                    ${currentUser.role === 'admin' ? `<button class="delete-btn" onclick="db.ref('projects/${id}').remove()">X</button>` : ''}
                </div>`;
            }
        }

        window.closeModal = () => { document.getElementById('details-modal').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; };
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('active');
    </script>
</body>
</html>