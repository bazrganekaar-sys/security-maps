<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Ø³ÛŒØ³ØªÛ•Ù…ÛŒ Ø¦Û•Ù…Ù†ÛŒ Ú©ÙˆØ±Ø¯Ø³ØªØ§Ù†</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <style>
        :root { --k-red: #ee352e; --k-yellow: #fecb00; --k-green: #27ae60; --k-dark: #1a252f; }
        body { margin: 0; font-family: sans-serif; height: 100vh; background: #f0f2f5; overflow: hidden; }
        #login-page { position: fixed; inset: 0; background: linear-gradient(135deg, var(--k-red), var(--k-yellow), var(--k-green)); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { background: white; padding: 30px; border-radius: 20px; width: 320px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .login-card input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        #main-app { display: none; width: 100%; height: 100%; }
        #map { height: 100vh; width: 100%; }
        #sidebar { position: fixed; top: 0; right: -400px; width: 380px; height: 100%; background: var(--k-dark); color: white; padding: 20px; transition: 0.3s; z-index: 2000; overflow-y: auto; box-sizing: border-box; }
        #sidebar.active { right: 0; }
        .toggle-btn { position: fixed; top: 20px; right: 20px; z-index: 2001; background: var(--k-green); color: white; width: 50px; height: 50px; border: none; border-radius: 50%; cursor: pointer; font-size: 20px; }
        .input-group { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; margin-bottom: 10px; }
        .dynamic-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .dynamic-row input { flex: 1; padding: 5px; border-radius: 4px; border: none; font-size: 12px; }
        .save-btn { background: var(--k-green); color: white; padding: 10px; width: 100%; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .locate-btn { background: white; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; border: 2px solid rgba(0,0,0,0.2); }
        #details-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 600px; background: white; padding: 20px; z-index: 3000; border-radius: 15px; max-height: 80vh; overflow-y: auto; color: black; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2999; }
    </style>
</head>
<body>

    <div id="login-page">
        <div class="login-card">
            <h2>Ø³ÛŒØ³ØªÛ•Ù…ÛŒ Ø¦Û•Ù…Ù†ÛŒ</h2>
            <input type="text" id="login-user" placeholder="Ù†Ø§ÙˆÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±">
            <input type="password" id="login-pass" placeholder="Ù¾Ø§Ø³Û†Ø±Ø¯">
            <button onclick="checkLogin()" style="width:100%; padding:10px; background:var(--k-dark); color:white; border:none; border-radius:8px; cursor:pointer;">Ø¯Ø§Ø®ÚµØ¨ÙˆÙˆÙ†</button>
        </div>
    </div>

    <div id="main-app">
        <button class="toggle-btn" onclick="toggleSidebar()">â˜°</button>
        <div id="sidebar">
            <h3 id="user-welcome"></h3>
            <div id="admin-controls" style="display:none;">
                <div class="input-group">
                    <input type="text" id="p_name" placeholder="Ù†Ø§ÙˆÛŒ Ù¾Ú•Û†Ú˜Û•" style="width:90%; padding:8px; margin-bottom:5px;">
                    <input type="text" id="p_shift" placeholder="Ø´Û•ÙØª" style="width:90%; padding:8px;">
                </div>
                <div class="input-group" id="group-tl"><span>ØªÛŒÙ… Ù„ÛØ¯Û•Ø±</span> <button onclick="addRow('group-tl')">+</button></div>
                <div class="input-group" id="group-guard"><span>Ù¾Ø§Ø³Û•ÙˆØ§Ù†</span> <button onclick="addRow('group-guard')">+</button></div>
                <div class="input-group" id="group-car"><span>Ø¦Û†ØªÛ†Ù…Ø¨ÛÙ„</span> <button onclick="addRow('group-car')">+</button></div>
                <div class="input-group" id="group-wp"><span>Ú†Û•Ú©</span> <button onclick="addRow('group-wp')">+</button></div>
                
                <input type="hidden" id="lat"><input type="hidden" id="lng">
                <button onclick="saveToCloud()" class="save-btn">Ù¾Ø§Ø´Û•Ú©Û•ÙˆØªÚ©Ø±Ø¯Ù†</button>
            </div>
            <div id="items-container" style="margin-top:20px;"></div>
            <button onclick="location.reload()" style="margin-top:20px; background:red; color:white; border:none; padding:10px; width:100%; cursor:pointer;">Ø¯Û•Ø±Ú†ÙˆÙˆÙ†</button>
        </div>
        <div id="map"></div>
    </div>

    <div class="overlay" id="overlay" onclick="closeModal()"></div>
    <div id="details-modal"><div id="m_content"></div><button onclick="closeModal()">Ø¯Ø§Ø®Ø³ØªÙ†</button></div>

    <script>
        // Ú•ÛÚ©Ø®Ø³ØªÙ†ÛŒ ÙØ§ÛŒÛ•Ø±Ø¨Û•ÛŒØ³
        const firebaseConfig = {
            apiKey: "AIzaSyDLrsmG0rFXohabE6VSI-JTrC0EGpo3f6k",
            authDomain: "manager-map-7e19c.firebaseapp.com",
            databaseURL: "https://manager-map-7e19c-default-rtdb.firebaseio.com",
            projectId: "manager-map-7e19c",
            storageBucket: "manager-map-7e19c.firebasestorage.app",
            messagingSenderId: "1038922185503",
            appId: "1:1038922185503:web:de08e0c5ad0b7e15778e2a"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentUser = null;
        let map, editMarker, allMarkers = [];

        function checkLogin() {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            if(u === "admin" && p === "3515217320251097") {
                currentUser = {name: "Ø¦Û•Ø¯Ù…ÛŒÙ†", role: "admin"};
                startApp();
            } else {
                alert("Ù‡Û•ÚµÛ•ÛŒÛ•!");
            }
        }

        function startApp() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            
            map = L.map('map', {zoomControl: false}).setView([36.19, 44.01], 8);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            // Ú¯Û•Ú•Ø§Ù†
            L.Control.geocoder({position:'topleft'}).addTo(map);

            // Ø´ÙˆÛÙ†ÛŒ Ù…Ù†
            const LocBtn = L.Control.extend({
                options: {position: 'topleft'},
                onAdd: function() {
                    const b = L.DomUtil.create('div', 'locate-btn leaflet-bar leaflet-control');
                    b.innerHTML = 'ğŸ“';
                    b.onclick = () => map.locate({setView: true, maxZoom: 15});
                    return b;
                }
            });
            map.addControl(new LocBtn());

            if(currentUser.role === 'admin') {
                document.getElementById('admin-controls').style.display = 'block';
                map.on('click', e => {
                    if(editMarker) map.removeLayer(editMarker);
                    editMarker = L.marker(e.latlng).addTo(map);
                    document.getElementById('lat').value = e.latlng.lat;
                    document.getElementById('lng').value = e.latlng.lng;
                });
            }

            db.ref('projects').on('value', snap => {
                const data = snap.val();
                allMarkers.forEach(m => map.removeLayer(m));
                const cont = document.getElementById('items-container');
                cont.innerHTML = "";
                for(let id in data) {
                    const p = data[id];
                    const m = L.marker([p.lat, p.lng]).addTo(map).bindPopup(`<button onclick="showDetails('${id}')">${p.name}</button>`);
                    allMarkers.push(m);
                    cont.innerHTML += `<div style="padding:10px; background:#333; margin-bottom:5px; border-radius:5px; cursor:pointer;" onclick="map.setView([${p.lat},${p.lng}], 15)">ğŸ“ ${p.name}</div>`;
                }
            });
        }

        function addRow(id) {
            const g = document.getElementById(id);
            const d = document.createElement('div'); d.className = 'dynamic-row';
            d.innerHTML = '<input type="text" placeholder="Ù†Ø§Ùˆ"> <input type="text" placeholder="Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ">';
            g.appendChild(d);
        }

        function collect(id) {
            const rows = document.getElementById(id).querySelectorAll('.dynamic-row');
            let res = [];
            rows.forEach(r => {
                const ins = r.querySelectorAll('input');
                if(ins[0].value) res.push({c1: ins[0].value, c2: ins[1].value});
            });
            return res;
        }

        function saveToCloud() {
            const name = document.getElementById('p_name').value;
            const lat = document.getElementById('lat').value;
            if(!name || !lat) return alert("Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ ØªÛ•ÙˆØ§Ùˆ Ù†ÛŒÛŒÛ•!");
            db.ref('projects').push({
                name: name, shift: document.getElementById('p_shift').value,
                tls: collect('group-tl'), guards: collect('group-guard'),
                cars: collect('group-car'), weapons: collect('group-wp'),
                lat: lat, lng: document.getElementById('lng').value
            });
            alert("Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ú©Ø±Ø§!");
        }

        window.showDetails = function(id) {
            db.ref('projects/' + id).once('value', snap => {
                const p = snap.val();
                let h = `<h3>${p.name}</h3><p>Ø´Û•ÙØª: ${p.shift}</p><hr>`;
                const build = (title, d) => {
                    if(!d) return '';
                    let t = `<b>${title}:</b><br>`;
                    d.forEach(x => t += `- ${x.c1}: ${x.c2}<br>`);
                    return t + '<br>';
                }
                h += build("ØªÛŒÙ… Ù„ÛØ¯Û•Ø±", p.tls) + build("Ù¾Ø§Ø³Û•ÙˆØ§Ù†", p.guards) + build("Ø¦Û†ØªÛ†Ù…Ø¨ÛÙ„", p.cars) + build("Ú†Û•Ú©", p.weapons);
                document.getElementById('m_content').innerHTML = h;
                document.getElementById('details-modal').style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
            });
        }

        window.closeModal = () => { document.getElementById('details-modal').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; };
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('active');
    </script>
</body>
</html>
